<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculateur SPRINT & GMT</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <style>
    body { background:#f1f5f9; color:#0f172a; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 8px 28px rgba(2,6,23,.06); border:1px solid #e2e8f0; }
    .btn { padding:.6rem 1rem; border-radius:.6rem; font-weight:700; transition:.2s; border:1px solid #e5e7eb; background:#f3f4f6; }
    .btn:hover { background:#e5e7eb; }
    .btn-primary { background:#2563eb; color:#fff; border-color:#2563eb; }
    .btn-primary:hover { background:#1d4ed8; }
    .tab-active { background:#2563eb!important; color:#fff!important; }
    .input { width:100%; padding:.55rem .75rem; border:1px solid #cbd5e1; border-radius:.55rem; }
    .label { font-size:.85rem; font-weight:600; color:#475569; }
    .title { font-size:1.25rem; font-weight:800; color:#1e293b; }
    .subtitle { font-size:.95rem; color:#64748b; }
    .highlight { font-size:1.25rem; font-weight:900; }
    .muted { color:#64748b; }
    pre { white-space:pre-wrap; }
    .pill { font-size:.75rem; font-weight:700; padding:.2rem .6rem; border-radius:9999px; }
    .ok { background:#dcfce7; color:#166534; }
    .bad { background:#fee2e2; color:#991b1b; }
    .delta-ok { color:#166534; font-weight:600; }
    .delta-bad { color:#991b1b; font-weight:600; }

    /* Dark mode */
    .dark body { background:#0b1220; color:#e5e7eb; }
    .dark .card { background:#0f172a; border-color:#1f2a44; box-shadow:0 8px 28px rgba(0,0,0,.35); }
    .dark .btn { background:#0b1220; color:#e5e7eb; border-color:#1f2a44; }
    .dark .btn:hover { background:#111a2e; }
    .dark .btn-primary { background:#3b82f6; border-color:#3b82f6; }
    .dark .btn-primary:hover { background:#2563eb; }
    .dark .input { background:#0b1220; color:#e5e7eb; border-color:#1f2a44; }
    .dark .subtitle { color:#93a4c4; }
    .dark .muted { color:#7c8bb0; }
    .dark .bg-gray-50 { background:#0b1220; }
    .dark .border { border-color:#1f2a44; }
    .dark .ok { background:#134e4a; color:#a7f3d0; }
    .dark .bad { background:#7f1d1d; color:#fecaca; }
  </style>
</head>
<body class="p-6">
  <main class="max-w-6xl mx-auto space-y-6">
    <header class="flex items-center justify-between pb-3 border-b border-gray-200">
      <h1 class="text-2xl font-black">‚öôÔ∏è Calculateur <span class="text-blue-600">SPRINT</span> & <span class="text-green-600">GMT</span></h1>
      <div class="flex items-center gap-2">
        <button id="btnTheme" class="btn" title="Basculer th√®me" type="button">üåô</button>
        <span class="bg-gray-200 px-2 py-1 rounded text-xs">v7.4 ‚Äî Fix script tronqu√© + switch NST OK</span>
      </div>
    </header>

    <!-- Onglets principaux -->
    <div class="flex rounded-lg overflow-hidden border border-gray-200">
      <button id="tabSprint" class="flex-1 btn tab-active" type="button">SPRINT</button>
      <button id="tabGmt" class="flex-1 btn" type="button">GMT</button>
    </div>

    <!-- SPRINT -->
    <section id="viewSprint" class="card p-6">
      <h2 class="title flex items-center gap-3">SPRINT (<span id="sprintMode">NST1</span>)
        <span class="ml-auto inline-flex items-center gap-2 text-xs font-semibold text-gray-500">
          <span id="roleChip" class="pill bg-gray-200">A=Frein ‚Ä¢ B=Coupe</span>
          <span class="inline-flex rounded-lg overflow-hidden border">
            <button id="btnNST1" type="button" class="btn px-3 py-1 !rounded-none tab-active">NST1</button>
            <button id="btnNST2" type="button" class="btn px-3 py-1 !rounded-none">NST2</button>
          </span>
        </span>
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label" id="labelAttA">Attendu A (Frein)</label>
          <input id="attA" type="number" step="0.1" class="input" value="150" />
          <label class="label" id="labelAttB">Attendu B (Coupe)</label>
          <input id="attB" type="number" step="0.1" class="input" value="150" />
        </div>
        <div>
          <label class="label" id="labelMesA">Mesur√© A (Frein)</label>
          <input id="mesA" type="number" step="0.1" class="input" value="149.5" />
          <label class="label" id="labelMesB">Mesur√© B (Coupe)</label>
          <input id="mesB" type="number" step="0.1" class="input" value="150.2" />
        </div>
      </div>
      <div class="mt-4 flex items-center gap-3">
        <div id="sTol" class="pill ok">‚Äî</div>
        <div id="sVals" class="text-sm text-gray-600">‚Äî</div>
      </div>
      <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded-lg border">
          <div class="subtitle">Centrage (IHM, pas 0,1)</div>
          <div id="sprintCentrage" class="highlight">‚Äî</div>
          <div id="sprintCentrageDir" class="text-xs muted">‚Äî</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg border">
          <div class="subtitle">Longueur fil (IHM, pas 0,25 mm)</div>
          <div id="sprintLongueur" class="highlight">‚Äî</div>
          <div id="sprintLongueurHint" class="text-xs muted">‚Äî</div>
        </div>
      </div>
      <details class="mt-4">
        <summary class="font-semibold">D√©tail du calcul</summary>
        <pre id="logSprint" class="text-xs bg-gray-50 p-3 rounded border"></pre>
      </details>
    </section>

    <!-- GMT -->
    <section id="viewGmt" class="card p-6 hidden">
      <h2 class="title mb-4">GMT</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="label">Attendu A</label>
          <input id="gAttA" type="number" step="0.5" class="input" value="110" />
          <label class="label">Attendu B</label>
          <input id="gAttB" type="number" step="0.5" class="input" value="110" />
        </div>
        <div>
          <label class="label">Mesur√© A</label>
          <input id="gMesA" type="number" step="0.5" class="input" value="108.5" />
          <label class="label">Mesur√© B</label>
          <input id="gMesB" type="number" step="0.5" class="input" value="108.5" />
        </div>
      </div>
      <div class="mt-4 flex items-center gap-3">
        <div id="gTol" class="pill ok">‚Äî</div>
        <div id="gVals" class="text-sm text-gray-600">‚Äî</div>
      </div>
      <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded-lg border">
          <div class="subtitle">Centrage (IHM, 1 unit√© = 0,2 mm)</div>
          <div id="gCentrage" class="highlight">‚Äî</div>
          <div id="gCentrageDir" class="text-xs muted">‚Äî</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg border">
          <div class="subtitle">Mise en angle (dents / ¬Ω dent)</div>
          <div id="gLongueur" class="highlight">‚Äî</div>
          <div id="gLongueurHint" class="text-xs muted">‚Äî</div>
        </div>
      </div>
      <details class="mt-4">
        <summary class="font-semibold">D√©tail du calcul</summary>
        <pre id="logGmt" class="text-xs bg-gray-50 p-3 rounded border"></pre>
      </details>
    </section>

    <!-- TESTS -->
    <section class="card p-6">
      <details>
        <summary class="font-semibold">üß™ Tests int√©gr√©s</summary>
        <div class="mt-3 flex gap-2">
          <button id="btnRunTests" class="btn btn-primary" type="button">Ex√©cuter</button>
          <button id="btnReset" class="btn" type="button">R√©initialiser</button>
        </div>
        <pre id="testOut" class="text-xs bg-gray-50 p-3 rounded border mt-3 whitespace-pre-wrap"></pre>
      </details>
    </section>
  </main>

  <script>
  // ===== Utils =====
  const $ = (id) => document.getElementById(id);
  const fr = (n) => Number(n ?? 0);
  const snap = (v, step) => Math.round(v/step)*step; // arrondi au pas
  const fmtSign = (v,d=2) => `${v>=0?'+':''}${v.toFixed(d)}`;
  function formatDelta(val,tol){const cls=Math.abs(val)<=tol?'delta-ok':'delta-bad';return `<span class="${cls}">Œî ${val.toFixed(2)}</span>`;}

  // ===== Tabs =====
  window.switchTab=function(tab){
    $("viewSprint").classList.toggle('hidden',tab!=='sprint');
    $("viewGmt").classList.toggle('hidden',tab!=='gmt');
    $("tabSprint").classList.toggle('tab-active',tab==='sprint');
    $("tabGmt").classList.toggle('tab-active',tab==='gmt');
    try{localStorage.setItem('calc.tab',tab);}catch(_){}
  }

  // ===== Theme =====
  const THEME_KEY='calc.theme';
  function getTheme(){try{return localStorage.getItem(THEME_KEY)||'light';}catch(e){return'light';}}
  function setTheme(t){try{localStorage.setItem(THEME_KEY,t);}catch(e){}}
  function applyTheme(){const t=getTheme();document.documentElement.classList.toggle('dark',t==='dark');const b=$("btnTheme");if(b)b.textContent=(t==='dark')?'‚òÄÔ∏è':'üåô';}
  window.toggleTheme=function(){setTheme(getTheme()==='dark'?'light':'dark');applyTheme();}
  function initTheme(){applyTheme();}

  // ===== SPRINT: Centrage ‚áí Longueur (avec inversion NST1/NST2) =====
  function runSprint(){
    const attA=fr($("attA").value),attB=fr($("attB").value);
    const mesA=fr($("mesA").value),mesB=fr($("mesB").value);
    const tol=0.5;

    const mode=window._sprintMode||'NST1';
    const freinAtt=(mode==='NST1')?attA:attB;
    const coupeAtt=(mode==='NST1')?attB:attA;
    const freinMes=(mode==='NST1')?mesA:mesB;
    const coupeMes=(mode==='NST1')?mesB:mesA;

    const dA0=mesA-attA,dB0=mesB-attB;
    const errA=Math.abs(dA0),errB=Math.abs(dB0);

    const kC=0.2; // IHM/mm pour centrage
    const kL=1.5; // IHM/mm pour longueur (SPRINT)

    const log=[];

    if(errA<=tol && errB<=tol){
      $("sTol").textContent='D√©j√† conforme';
      $("sTol").className='pill ok';
      $("sVals").innerHTML=`A ${mesA} / ${attA} (${formatDelta(dA0,tol)}), B ${mesB} / ${attB} (${formatDelta(dB0,tol)})`;
      $("sprintCentrage").textContent='0.0';
      $("sprintCentrageDir").textContent='‚úÖ D√©j√† conforme ‚Äî pas de centrage';
      $("sprintLongueur").textContent='0.00 mm';
      $("sprintLongueurHint").textContent='‚Äî';
      log.push(`‚úÖ D√©j√† conforme (mode ${mode})`);
    } else {
      // 1) Centrage (bas√© sur l'√©cart Coupe), pas 0,1
      const centBrut=(coupeMes-coupeAtt)*kC;  // + vers Frein / - vers Coupe
      const centIHM=snap(centBrut,0.1);
      const dCent=centIHM/kC;                 // mm r√©els
      const A1=(mode==='NST1')?(mesA+dCent):(mesA-dCent);
      const B1=(mode==='NST1')?(mesB-dCent):(mesB+dCent);

      $("sprintCentrage").textContent=fmtSign(centIHM,1);
      $("sprintCentrageDir").textContent=centIHM>0?'‚Üí Ramener vers Frein':(centIHM<0?'‚Üí Ramener vers Coupe':'‚Äî');

      // 2) Longueur (sur Frein apr√®s centrage), pas 0,25
      const freinApres=(mode==='NST1')?A1:B1;
      const lenBrut=(freinAtt-freinApres)*kL;
      const lenIHM=snap(lenBrut,0.25);
      const dLen=lenIHM/kL;
      const A2=(mode==='NST1')?(A1+dLen):A1;
      const B2=(mode==='NST1')?B1:(B1+dLen);

      $("sprintLongueur").textContent=`${fmtSign(lenIHM,2)} mm`;
      $("sprintLongueurHint").textContent=lenIHM>0?'‚Üí Allonger':(lenIHM<0?'‚Üí Raccourcir':'‚Äî');

      $("sTol").textContent='Correction requise';
      $("sTol").className='pill bad';
      $("sVals").innerHTML=`A ${mesA} / ${attA} (${formatDelta(dA0,tol)}), B ${mesB} / ${attB} (${formatDelta(dB0,tol)})`;

      log.push(`‚ö†Ô∏è Mode ${mode}`);
      log.push(`Centrage: brut ${centBrut.toFixed(3)} ‚áí IHM ${fmtSign(centIHM,1)} ‚áí Œî=${fmtSign(dCent,2)} mm`);
      log.push(`Apr√®s centrage: A1=${A1.toFixed(2)}, B1=${B1.toFixed(2)}`);
      log.push(`Longueur: brut ${lenBrut.toFixed(3)} ‚áí IHM ${fmtSign(lenIHM,2)} (effet ${fmtSign(dLen,2)} mm sur Frein)`);
      log.push(`Final pr√©vu: A‚âà${A2.toFixed(2)} / B‚âà${B2.toFixed(2)} (tol ¬±${tol})`);
    }

    $("logSprint").textContent = log.join("\n");
  }

  // ===== GMT: Mise en angle ‚áí Centrage =====
  function runGmt(){
    const attA=fr($("gAttA").value), attB=fr($("gAttB").value);
    const mesA=fr($("gMesA").value), mesB=fr($("gMesB").value);
    const tol=0.5;

    const MM_PER_DENT=2.78;               // mm total par dent
    const HALF=MM_PER_DENT/2;             // 1.39 mm
    const IHM_PER_MM_CENTER=5;            // +5 IHM = +1 mm vers A

    // 1) Mise en angle ‚Äî corrige la somme totale
    const sumAtt=attA+attB, sumMes=mesA+mesB;
    const needTotal=sumAtt-sumMes;                     // mm √† ajouter au total
    const halfDentCount=Math.round(needTotal/HALF);    // en 1/2 dent
    const totalAdded=halfDentCount*HALF;               // mm total appliqu√©
    const perSide=totalAdded/2;                        // r√©partition sym√©trique

    const A1=mesA+perSide, B1=mesB+perSide;

    // 2) Centrage ‚Äî r√©partition sans changer la somme
    const needShiftA=attA-A1;                          // mm √† donner √† A
    const centIHMraw=needShiftA*IHM_PER_MM_CENTER;     // + vers A / - vers B
    const centIHM=Math.round(centIHMraw);              // pas 1 IHM
    const dCent=centIHM/IHM_PER_MM_CENTER;             // mm

    const A2=A1+dCent, B2=B1-dCent;

    // Badges init
    const dA0=mesA-attA, dB0=mesB-attB; const errA0=Math.abs(dA0), errB0=Math.abs(dB0);
    if(errA0<=tol && errB0<=tol){ $("gTol").textContent='D√©j√† conforme'; $("gTol").className='pill ok'; }
    else { $("gTol").textContent='Correction requise'; $("gTol").className='pill bad'; }
    $("gVals").innerHTML=`A ${mesA} / ${attA} (${formatDelta(dA0,tol)}), B ${mesB} / ${attB} (${formatDelta(dB0,tol)})`;

    // Sorties ‚Äî Mise en angle
    let labelDents;
    if(halfDentCount===0) labelDents='0 dent';
    else if(halfDentCount%2===0){ const dents=halfDentCount/2; labelDents=`${dents>=0?'+':''}${dents} dent${Math.abs(dents)===1?'':'s'}`; }
    else labelDents=`${halfDentCount>=0?'+':''}${halfDentCount}/2 dent`;

    $("gLongueur").textContent = `${labelDents} (${fmtSign(totalAdded,2)} mm total, ${fmtSign(perSide,2)} mm/side)`;
    $("gLongueurHint").textContent = halfDentCount>0 ? '‚Üí Ajouter des dents (allonger)' : (halfDentCount<0 ? '‚Üí Retirer des dents (raccourcir)' : '‚Äî Aucun ajustement de longueur');

    // Sorties ‚Äî Centrage
    $("gCentrage").textContent = `${centIHM>=0?'+':''}${centIHM}`;
    $("gCentrageDir").textContent = centIHM>0 ? '‚Üí Ramener vers A' : (centIHM<0 ? '‚Üí Ramener vers B' : '‚Äî D√©j√† centr√©');

    // Journal
    const log=[];
    log.push('üßÆ GMT ‚Äî Mise en angle (longueur totale) puis centrage');
    log.push(`Sommes: mes=${sumMes.toFixed(2)} vs att=${sumAtt.toFixed(2)} ‚áí besoin total = ${fmtSign(needTotal,2)} mm`);
    log.push(`Mise en angle: ${labelDents} ‚áí ${fmtSign(totalAdded,2)} mm total (¬±${perSide.toFixed(2)} mm par c√¥t√©)`);
    log.push(`Apr√®s angle: A1‚âà${A1.toFixed(2)}, B1‚âà${B1.toFixed(2)}`);
    log.push(`Centrage: besoin A = ${fmtSign(needShiftA,2)} mm ‚áí IHM ‚âà ${fmtSign(centIHMraw,2)} ‚áí retenu ${centIHM}`);
    log.push(`Pr√©diction finale: A‚âà${A2.toFixed(2)} / B‚âà${B2.toFixed(2)} (tol ¬±${tol})`);
    $("logGmt").textContent = log.join("\n");
  }

  // ===== Tests =====
  function runTests(){
    const out=[];
    try{
      out.push(`T0 typeof switchTab: ${typeof window.switchTab}`);
      // Theme toggle
      const wasDark=document.documentElement.classList.contains('dark'); window.toggleTheme(); const nowDark=document.documentElement.classList.contains('dark'); out.push(`T1 Theme: ${wasDark!==nowDark?'OK':'FAIL'}`); window.toggleTheme();
      // Tabs
      window.switchTab('gmt'); out.push(`T2 tabs‚Üígmt: ${!$("viewGmt").classList.contains('hidden')?'OK':'FAIL'}`); window.switchTab('sprint');
      // NST switch mapping
      const bak={a:$("attA").value,b:$("attB").value,ma:$("mesA").value,mb:$("mesB").value};
      $("attA").value=150; $("attB").value=150; $("mesA").value=150.5; $("mesB").value=150.0;
      // NST1: Coupe=B, donc ŒîCoupe‚âà0 ‚Üí centrage‚âà0
      setMode('NST1'); runSprint(); out.push(`T3 NST1 centrage=${$("sprintCentrage").textContent}`);
      // NST2: Coupe=A, ŒîCoupe=+0.5 ‚Üí centrage‚âà+0.1
      setMode('NST2'); runSprint(); out.push(`T3 NST2 centrage=${$("sprintCentrage").textContent}`);
      // restore
      $("attA").value=bak.a; $("attB").value=bak.b; $("mesA").value=bak.ma; $("mesB").value=bak.mb; setMode(localStorage.getItem('calc.sprintMode')||'NST1'); runSprint();
      out.push('T4 OK');
    }catch(e){ out.push('‚ùå Tests exception: '+(e&&e.message||e)); }
    $("testOut").textContent=out.join("\n");
  }

  function resetAll(){
    $("attA").value=150; $("attB").value=150; $("mesA").value=149.5; $("mesB").value=150.2;
    $("gAttA").value=110; $("gAttB").value=110; $("gMesA").value=108.5; $("gMesB").value=108.5;
    runSprint(); runGmt();
  }

  // ===== Init & Mode wiring =====
  function refreshModeUI(){
    const mode=window._sprintMode||'NST1';
    $("sprintMode").textContent=mode;
    const b1=$("btnNST1"), b2=$("btnNST2"); if(b1&&b2){ b1.classList.toggle('tab-active',mode==='NST1'); b2.classList.toggle('tab-active',mode==='NST2'); }
    if(mode==='NST1'){
      $("labelAttA").textContent='Attendu A (Frein)';
      $("labelAttB").textContent='Attendu B (Coupe)';
      $("labelMesA").textContent='Mesur√© A (Frein)';
      $("labelMesB").textContent='Mesur√© B (Coupe)';
      $("roleChip").textContent='A=Frein ‚Ä¢ B=Coupe';
    }else{
      $("labelAttA").textContent='Attendu A (Coupe)';
      $("labelAttB").textContent='Attendu B (Frein)';
      $("labelMesA").textContent='Mesur√© A (Coupe)';
      $("labelMesB").textContent='Mesur√© B (Frein)';
      $("roleChip").textContent='A=Coupe ‚Ä¢ B=Frein';
    }
  }

  function setMode(m){ window._sprintMode=m; try{ localStorage.setItem('calc.sprintMode', m);}catch(_){} refreshModeUI(); runSprint(); }

  document.addEventListener('DOMContentLoaded',()=>{
    initTheme(); const btn=$("btnTheme"); if(btn) btn.addEventListener('click', window.toggleTheme);

    // Mode NST persist
    window._sprintMode = localStorage.getItem('calc.sprintMode') || 'NST1';
    refreshModeUI();
    const n1=$("btnNST1"), n2=$("btnNST2");
    if(n1) n1.addEventListener('click', ()=>setMode('NST1'));
    if(n2) n2.addEventListener('click', ()=>setMode('NST2'));

    // Tabs
    const lastTab=localStorage.getItem('calc.tab')||'sprint';
    $("tabSprint").addEventListener('click',()=>window.switchTab('sprint'));
    $("tabGmt").addEventListener('click',()=>window.switchTab('gmt'));
    window.switchTab(lastTab);

    // Live recalc
    ['attA','attB','mesA','mesB'].forEach(id=>{const el=$(id); if(el) el.addEventListener('input', runSprint);});
    ['gAttA','gAttB','gMesA','gMesB'].forEach(id=>{const el=$(id); if(el) el.addEventListener('input', runGmt);});

    // Tests & reset
    const b1=$("btnRunTests"); if(b1) b1.addEventListener('click', runTests);
    const b2=$("btnReset"); if(b2) b2.addEventListener('click', resetAll);

    // Initial calc
    runSprint();
    runGmt();
  });
  </script>
</body>
</html>
