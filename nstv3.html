<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculateur SPRINT & GMT</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <style>
    body { background:#f1f5f9; color:#0f172a; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 8px 28px rgba(2,6,23,.06); border:1px solid #e2e8f0; }
    .btn { padding:.6rem 1rem; border-radius:.6rem; font-weight:700; transition:.2s; border:1px solid #e5e7eb; background:#f3f4f6; }
    .btn:hover { background:#e5e7eb; }
    .btn-primary { background:#2563eb; color:#fff; border-color:#2563eb; }
    .btn-primary:hover { background:#1d4ed8; }
    .tab-active { background:#2563eb!important; color:#fff!important; }
    .input { width:100%; padding:.55rem .75rem; border:1px solid #cbd5e1; border-radius:.55rem; }
    .label { font-size:.85rem; font-weight:600; color:#475569; }
    .title { font-size:1.25rem; font-weight:800; color:#1e293b; }
    .subtitle { font-size:.95rem; color:#64748b; }
    .highlight { font-size:1.25rem; font-weight:900; }
    .muted { color:#64748b; }
    pre { white-space:pre-wrap; }
    .pill { font-size:.75rem; font-weight:700; padding:.2rem .6rem; border-radius:9999px; }
    .ok { background:#dcfce7; color:#166534; }
    .bad { background:#fee2e2; color:#991b1b; }
    .delta-ok { color:#166534; font-weight:600; }
    .delta-bad { color:#991b1b; font-weight:600; }

    /* Dark mode */
    .dark body { background:#0b1220; color:#e5e7eb; }
    .dark .card { background:#0f172a; border-color:#1f2a44; box-shadow:0 8px 28px rgba(0,0,0,.35); }
    .dark .btn { background:#0b1220; color:#e5e7eb; border-color:#1f2a44; }
    .dark .btn:hover { background:#111a2e; }
    .dark .btn-primary { background:#3b82f6; border-color:#3b82f6; }
    .dark .btn-primary:hover { background:#2563eb; }
    .dark .input { background:#0b1220; color:#e5e7eb; border-color:#1f2a44; }
    .dark .subtitle { color:#93a4c4; }
    .dark .muted { color:#7c8bb0; }
    .dark .bg-gray-50 { background:#0b1220; }
    .dark .border { border-color:#1f2a44; }
    .dark .ok { background:#134e4a; color:#a7f3d0; }
    .dark .bad { background:#7f1d1d; color:#fecaca; }
  </style>
</head>
<body class="p-6">
  <main class="max-w-6xl mx-auto space-y-6">
    <header class="flex items-center justify-between pb-3 border-b border-gray-200">
      <h1 class="text-2xl font-black">‚öôÔ∏è Calculateur <span class="text-blue-600">SPRINT</span> & <span class="text-green-600">GMT</span></h1>
      <div class="flex items-center gap-2">
        <button id="btnTheme" class="btn" title="Basculer th√®me" type="button">üåô</button>
        <span class="bg-gray-200 px-2 py-1 rounded text-xs">v7.1 ‚Äî Fix syntaxe JS + GMT (angle‚Üícentrage) + tests</span>
      </div>
    </header>

    <!-- Onglets principaux -->
    <div class="flex rounded-lg overflow-hidden border border-gray-200">
      <button id="tabSprint" class="flex-1 btn tab-active" type="button">SPRINT</button>
      <button id="tabGmt" class="flex-1 btn" type="button">GMT</button>
    </div>

    <!-- SPRINT -->
    <section id="viewSprint" class="card p-6">
      <h2 class="title">SPRINT (<span id="sprintMode">NST1</span>)</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label">Attendu A (Frein)</label>
          <input id="attA" type="number" step="0.1" class="input" value="150" />
          <label class="label">Attendu B (Coupe)</label>
          <input id="attB" type="number" step="0.1" class="input" value="150" />
        </div>
        <div>
          <label class="label">Mesur√© A (Frein)</label>
          <input id="mesA" type="number" step="0.1" class="input" value="149.5" />
          <label class="label">Mesur√© B (Coupe)</label>
          <input id="mesB" type="number" step="0.1" class="input" value="150.2" />
        </div>
      </div>
      <div class="mt-4 flex items-center gap-3">
        <div id="sTol" class="pill ok">‚Äî</div>
        <div id="sVals" class="text-sm text-gray-600">‚Äî</div>
      </div>
      <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded-lg border">
          <div class="subtitle">Centrage (IHM, pas 0,1)</div>
          <div id="sprintCentrage" class="highlight">‚Äî</div>
          <div id="sprintCentrageDir" class="text-xs muted">‚Äî</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg border">
          <div class="subtitle">Longueur fil (IHM, pas 0,25 mm)</div>
          <div id="sprintLongueur" class="highlight">‚Äî</div>
          <div id="sprintLongueurHint" class="text-xs muted">‚Äî</div>
        </div>
      </div>
      <details class="mt-4">
        <summary class="font-semibold">D√©tail du calcul</summary>
        <pre id="logSprint" class="text-xs bg-gray-50 p-3 rounded border"></pre>
      </details>
    </section>

    <!-- GMT -->
    <section id="viewGmt" class="card p-6 hidden">
      <h2 class="title mb-4">GMT</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="label">Attendu A</label>
          <input id="gAttA" type="number" step="0.5" class="input" value="110" />
          <label class="label">Attendu B</label>
          <input id="gAttB" type="number" step="0.5" class="input" value="110" />
        </div>
        <div>
          <label class="label">Mesur√© A</label>
          <input id="gMesA" type="number" step="0.5" class="input" value="108.5" />
          <label class="label">Mesur√© B</label>
          <input id="gMesB" type="number" step="0.5" class="input" value="108.5" />
        </div>
      </div>
      <div class="mt-4 flex items-center gap-3">
        <div id="gTol" class="pill ok">‚Äî</div>
        <div id="gVals" class="text-sm text-gray-600">‚Äî</div>
      </div>
      <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded-lg border">
          <div class="subtitle">Centrage (IHM, 1 unit√© = 0,2 mm)</div>
          <div id="gCentrage" class="highlight">‚Äî</div>
          <div id="gCentrageDir" class="text-xs muted">‚Äî</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg border">
          <div class="subtitle">Mise en angle (dents / ¬Ω dent)</div>
          <div id="gLongueur" class="highlight">‚Äî</div>
          <div id="gLongueurHint" class="text-xs muted">‚Äî</div>
        </div>
      </div>
      <details class="mt-4">
        <summary class="font-semibold">D√©tail du calcul</summary>
        <pre id="logGmt" class="text-xs bg-gray-50 p-3 rounded border"></pre>
      </details>
    </section>

    <!-- TESTS -->
    <section class="card p-6">
      <details>
        <summary class="font-semibold">üß™ Tests int√©gr√©s</summary>
        <div class="mt-3 flex gap-2">
          <button id="btnRunTests" class="btn btn-primary" type="button">Ex√©cuter</button>
          <button id="btnReset" class="btn" type="button">R√©initialiser</button>
        </div>
        <pre id="testOut" class="text-xs bg-gray-50 p-3 rounded border mt-3 whitespace-pre-wrap"></pre>
      </details>
    </section>
  </main>

  <script>
  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);
  const fr = (n) => Number(n ?? 0);
  const snap = (v, step) => Math.round(v/step)*step; // arrondi au pas
  const fmtSign = (v, d=2) => `${v>=0?'+':''}${v.toFixed(d)}`;
  function formatDelta(val, tol){
    const cls = Math.abs(val) <= tol ? 'delta-ok' : 'delta-bad';
    return `<span class="${cls}">Œî ${val.toFixed(2)}</span>`;
  }

  // ===== Tabs (global) =====
  window.switchTab = function(tab){
    $("viewSprint").classList.toggle('hidden', tab !== 'sprint');
    $("viewGmt").classList.toggle('hidden', tab !== 'gmt');
    $("tabSprint").classList.toggle('tab-active', tab === 'sprint');
    $("tabGmt").classList.toggle('tab-active', tab === 'gmt');
    try{ localStorage.setItem('calc.tab', tab); }catch(_){/* noop */}
  }

  // ===== Theme (global) =====
  const THEME_KEY = 'calc.theme';
  function getTheme(){ try { return localStorage.getItem(THEME_KEY) || 'light'; } catch(e){ return 'light'; } }
  function setTheme(t){ try { localStorage.setItem(THEME_KEY, t); } catch(e){} }
  function applyTheme(){
    const t = getTheme();
    document.documentElement.classList.toggle('dark', t==='dark');
    const b = $("btnTheme"); if(b) b.textContent = (t === 'dark') ? '‚òÄÔ∏è' : 'üåô';
  }
  window.toggleTheme = function(){ setTheme(getTheme()==='dark' ? 'light' : 'dark'); applyTheme(); }
  function initTheme(){ applyTheme(); }

  // ===== SPRINT: Centrage ‚áí Longueur =====
  function runSprint(){
    const attA = fr($("attA").value), attB = fr($("attB").value);
    const mesA = fr($("mesA").value), mesB = fr($("mesB").value);
    const tol = 0.5;
    const errA = Math.abs(attA - mesA), errB = Math.abs(attB - mesB);
    const dA0 = mesA - attA, dB0 = mesB - attB;

    // constantes process
    const kC = 0.2; // mm IHM par mm d'√©cart Coupe (B)
    const kL = 1.5; // mm IHM par mm d'√©cart Frein (A)

    let log = [];

    if(errA <= tol && errB <= tol){
      $("sTol").textContent='D√©j√† conforme';
      $("sTol").className='pill ok';
      $("sVals").innerHTML=`A ${mesA} / ${attA} (${formatDelta(dA0,tol)}), B ${mesB} / ${attB} (${formatDelta(dB0,tol)})`;
      $("sprintCentrage").textContent = '0.0';
      $("sprintCentrageDir").textContent = '‚úÖ D√©j√† conforme ‚Äî pas de centrage';
      $("sprintLongueur").textContent = '0.00 mm';
      $("sprintLongueurHint").textContent = '‚úÖ D√©j√† conforme ‚Äî pas de correction de longueur';
      log.push(`‚úÖ D√©j√† conforme (√©carts A=${errA.toFixed(2)}, B=${errB.toFixed(2)} ‚â§ ¬±${tol}) ‚Üí pas d‚Äôaction.`);
    } else {
      // 1) Centrage (pas 0,1)
      const centBrut = (mesB - attB) * kC;          // + vers Frein / - vers Coupe
      const centIHM  = snap(centBrut, 0.1);
      const dCent    = centIHM / kC;                 // mm r√©els
      const A1 = mesA + dCent;                       // Frein apr√®s centrage
      const B1 = mesB - dCent;                       // Coupe apr√®s centrage

      $("sprintCentrage").textContent = fmtSign(centIHM,1);
      $("sprintCentrageDir").textContent = centIHM>0 ? '‚Üí Ramener vers Frein' : (centIHM<0 ? '‚Üí Ramener vers Coupe' : '‚Äî');

      // 2) Longueur (pas 0,25) √† partir de A1
      const lenBrut = (attA - A1) * kL;              // + Allonger / - Raccourcir
      const lenIHM  = snap(lenBrut, 0.25);
      const dLen    = lenIHM / kL;                    // mm r√©els
      const A2 = A1 + dLen;                           // Frein final pr√©vu

      $("sprintLongueur").textContent = `${fmtSign(lenIHM,2)} mm`;
      $("sprintLongueurHint").textContent = lenIHM>0 ? '‚Üí Allonger' : (lenIHM<0 ? '‚Üí Raccourcir' : '‚Äî');

      $("sTol").textContent='Correction requise';
      $("sTol").className='pill bad';
      $("sVals").innerHTML=`A ${mesA} / ${attA} (${formatDelta(dA0,tol)}), B ${mesB} / ${attB} (${formatDelta(dB0,tol)})`;

      log.push('‚ö†Ô∏è Hors tol√©rance ‚Äî cha√Æne pr√©dictive: Centrage ‚áí Longueur');
      log.push(`‚Ä¢ Centrage brut ${(centBrut).toFixed(3)} ‚áí IHM 0,1 = ${fmtSign(centIHM,1)} ‚áí Œî=${fmtSign(dCent,2)} mm`);
      log.push(`  ‚Ü≥ Apr√®s centrage: Coupe‚âà${B1.toFixed(2)}, Frein‚âà${A1.toFixed(2)}`);
      log.push(`‚Ä¢ Longueur brute ${(lenBrut).toFixed(3)} mm ‚áí IHM 0,25 = ${fmtSign(lenIHM,2)} mm (effet ${fmtSign(dLen,2)} mm)`);
      log.push(`  ‚Ü≥ Pr√©diction finale: A‚âà${A2.toFixed(2)} / B‚âà${B1.toFixed(2)} (tol ¬±${tol})`);
    }

    $("logSprint").textContent = log.join("\n");
  }

  // ===== GMT: Mise en angle (longueur totale) ‚áí Centrage =====
  function runGmt(){
    const attA = fr($("gAttA").value), attB = fr($("gAttB").value);
    const mesA = fr($("gMesA").value), mesB = fr($("gMesB").value);
    const tol = 0.5;

    // Ratios GMT
    const MM_PER_DENT = 2.78;                 // mm total par dent
    const MM_PER_HALF_DENT = MM_PER_DENT/2;   // 1.39 mm total par 1/2 dent
    const IHM_PER_MM_CENTER = 5;              // +5 IHM = +1 mm vers A (donc 1 IHM = 0,2 mm)

    // 1) Mise en angle (corrige la somme totale)
    const sumAtt = attA + attB;
    const sumMes = mesA + mesB;
    const needTotal = sumAtt - sumMes;                             // mm √† ajouter au total (+ = allonger)
    const halfDentCount = Math.round(needTotal / MM_PER_HALF_DENT); // arrondi √† la 1/2 dent
    const totalAdded = halfDentCount * MM_PER_HALF_DENT;            // mm total appliqu√©
    const perSide = totalAdded / 2;                                 // sym√©trique

    const A1 = mesA + perSide;        // apr√®s angle
    const B1 = mesB + perSide;

    // 2) Centrage (r√©partition sans changer la somme)
    const needShiftA = attA - A1;                         // mm √† donner √† A
    const centIHMraw = needShiftA * IHM_PER_MM_CENTER;    // + vers A / - vers B
    const centIHM = Math.round(centIHMraw);               // pas 1 IHM
    const dCent = centIHM / IHM_PER_MM_CENTER;            // mm r√©els

    const A2 = A1 + dCent;
    const B2 = B1 - dCent;

    // Badges et Œî (√©tat initial)
    const errA0 = Math.abs(attA - mesA);
    const errB0 = Math.abs(attB - mesB);
    const dA0 = mesA - attA, dB0 = mesB - attB;
    if(errA0 <= tol && errB0 <= tol){
      $("gTol").textContent='D√©j√† conforme';
      $("gTol").className='pill ok';
    } else {
      $("gTol").textContent='Correction requise';
      $("gTol").className='pill bad';
    }
    $("gVals").innerHTML=`A ${mesA} / ${attA} (${formatDelta(dA0,tol)}), B ${mesB} / ${attB} (${formatDelta(dB0,tol)})`;

    // Sorties ‚Äî Mise en angle
    let labelDents;
    if(halfDentCount === 0){
      labelDents = '0 dent';
    } else if (halfDentCount % 2 === 0){
      const dents = halfDentCount/2;
      labelDents = `${dents>=0?'+':''}${dents} dent${Math.abs(dents)===1?'':'s'}`;
    } else {
      labelDents = `${halfDentCount>=0?'+':''}${halfDentCount}/2 dent`;
    }
    $("gLongueur").textContent = `${labelDents} (${fmtSign(totalAdded,2)} mm total, ${fmtSign(perSide,2)} mm/side)`;
    $("gLongueurHint").textContent = halfDentCount>0 ? '‚Üí Ajouter des dents (allonger)' : (halfDentCount<0 ? '‚Üí Retirer des dents (raccourcir)' : '‚Äî Aucun ajustement de longueur');

    // Sorties ‚Äî Centrage
    $("gCentrage").textContent = `${centIHM>=0?'+':''}${centIHM}`;
    $("gCentrageDir").textContent = centIHM>0 ? '‚Üí Ramener vers A' : (centIHM<0 ? '‚Üí Ramener vers B' : '‚Äî D√©j√† centr√©');

    // Journal
    const log=[];
    log.push('üßÆ GMT ‚Äî Mise en angle (longueur totale) puis centrage');
    log.push(`Sommes: mes=${sumMes.toFixed(2)} vs att=${sumAtt.toFixed(2)} ‚áí besoin total = ${fmtSign(needTotal,2)} mm`);
    log.push(`Mise en angle: ${labelDents} ‚áí ${fmtSign(totalAdded,2)} mm total (¬±${(perSide).toFixed(2)} mm par c√¥t√©)`);
    log.push(`Apr√®s angle: A1‚âà${A1.toFixed(2)}, B1‚âà${B1.toFixed(2)}`);
    log.push(`Centrage: besoin A = ${fmtSign(needShiftA,2)} mm ‚áí IHM ‚âà ${fmtSign(centIHMraw,2)} ‚áí retenu ${centIHM}`);
    log.push(`Pr√©diction finale: A‚âà${A2.toFixed(2)} / B‚âà${B2.toFixed(2)} (tol ¬±${tol})`);
    $("logGmt").textContent = log.join("\n");
  }

  // ===== Tests =====
  function runTests(){
    const out=[];
    try{
      // T0: fonctions globales pr√©sentes
      out.push(`T0 typeof switchTab: ${typeof window.switchTab}`);

      // T1: th√®me
      const wasDark = document.documentElement.classList.contains('dark');
      window.toggleTheme();
      const nowDark = document.documentElement.classList.contains('dark');
      out.push(`T1 Theme toggle: ${wasDark!==nowDark ? 'OK' : 'FAIL'}`);
      window.toggleTheme();

      // T2: switchTab + persistance
      window.switchTab('gmt');
      out.push(`T2‚Üígmt: ${!$("viewGmt").classList.contains('hidden') && $("tabGmt").classList.contains('tab-active') ? 'OK' : 'FAIL'}`);
      const stored = localStorage.getItem('calc.tab');
      out.push(`T2b stored=${stored}`);
      window.switchTab('sprint');

      // T3: SPRINT pr√©dictif ‚Äî sc√©nario de test
      const bak={a:$("attA").value,b:$("attB").value,ma:$("mesA").value,mb:$("mesB").value};
      $("attA").value=145; $("attB").value=145; $("mesA").value=141; $("mesB").value=149;
      runSprint();
      out.push('T3 SPRINT: OK');
      $("attA").value=bak.a; $("attB").value=bak.b; $("mesA").value=bak.ma; $("mesB").value=bak.mb; runSprint();

      // T4: GMT pr√©dictif ‚Äî sc√©nario de test
      const gbak={a:$("gAttA").value,b:$("gAttB").value,ma:$("gMesA").value,mb:$("gMesB").value};
      $("gAttA").value=110; $("gAttB").value=110; $("gMesA").value=108.5; $("gMesB").value=108.5;
      runGmt();
      out.push('T4 GMT: OK');
      $("gAttA").value=gbak.a; $("gAttB").value=gbak.b; $("gMesA").value=gbak.ma; $("gMesB").value=gbak.mb; runGmt();

    }catch(e){ out.push('‚ùå Exception tests: '+(e && e.message ? e.message : e)); }
    $("testOut").textContent = out.join("\n");
  }

  function resetAll(){
    $("attA").value=150; $("attB").value=150; $("mesA").value=149.5; $("mesB").value=150.2;
    $("gAttA").value=110; $("gAttB").value=110; $("gMesA").value=108.5; $("gMesB").value=108.5;
    runSprint(); runGmt();
  }

  // ===== Init =====
  document.addEventListener('DOMContentLoaded', () => {
    // Th√®me
    initTheme();
    const btn = $("btnTheme"); if(btn) btn.addEventListener('click', window.toggleTheme);

    // Onglets
    const lastTab = (localStorage.getItem('calc.tab')||'sprint');
    $("tabSprint").addEventListener('click', ()=>window.switchTab('sprint'));
    $("tabGmt").addEventListener('click', ()=>window.switchTab('gmt'));
    window.switchTab(lastTab);

    // Recalcul live
    ['attA','attB','mesA','mesB'].forEach(id=>{ const el=$(id); if(el) el.addEventListener('input', runSprint); });
    ['gAttA','gAttB','gMesA','gMesB'].forEach(id=>{ const el=$(id); if(el) el.addEventListener('input', runGmt); });

    // Tests & reset
    const b1=$("btnRunTests"); if(b1) b1.addEventListener('click', runTests);
    const b2=$("btnReset");    if(b2) b2.addEventListener('click', resetAll);

    // 1ers calculs
    runSprint();
    runGmt();
  });
  </script>
</body>
</html>
