<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculateur SPRINT & GMT</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <style>
    body { background:#f1f5f9; color:#0f172a; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 8px 28px rgba(2,6,23,.06); border:1px solid #e2e8f0; }
    .btn { padding:.6rem 1rem; border-radius:.6rem; font-weight:700; transition:.2s; border:1px solid #e5e7eb; background:#f3f4f6; }
    .btn:hover { background:#e5e7eb; }
    .btn-primary { background:#2563eb; color:#fff; border-color:#2563eb; }
    .btn-primary:hover { background:#1d4ed8; }
    .tab-active { background:#2563eb!important; color:#fff!important; }
    .input { width:100%; padding:.55rem .75rem; border:1px solid #cbd5e1; border-radius:.55rem; }
    .label { font-size:.85rem; font-weight:600; color:#475569; }
    .title { font-size:1.25rem; font-weight:800; color:#1e293b; }
    .subtitle { font-size:.95rem; color:#64748b; }
    .highlight { font-size:1.25rem; font-weight:900; }
    .muted { color:#64748b; }
    pre { white-space:pre-wrap; }
    .pill { font-size:.75rem; font-weight:700; padding:.2rem .6rem; border-radius:9999px; }
    .ok { background:#dcfce7; color:#166534; }
    .bad { background:#fee2e2; color:#991b1b; }

    /* Dark mode overrides */
    .dark body { background:#0b1220; color:#e5e7eb; }
    .dark .card { background:#0f172a; border-color:#1f2a44; box-shadow:0 8px 28px rgba(0,0,0,.35); }
    .dark .btn { background:#0b1220; color:#e5e7eb; border-color:#1f2a44; }
    .dark .btn:hover { background:#111a2e; }
    .dark .btn-primary { background:#3b82f6; border-color:#3b82f6; }
    .dark .btn-primary:hover { background:#2563eb; }
    .dark .input { background:#0b1220; color:#e5e7eb; border-color:#1f2a44; }
    .dark .subtitle { color:#93a4c4; }
    .dark .muted { color:#7c8bb0; }
    .dark .bg-gray-50 { background:#0b1220; }
    .dark .border { border-color:#1f2a44; }
    .dark .ok { background:#134e4a; color:#a7f3d0; }
    .dark .bad { background:#7f1d1d; color:#fecaca; }
  </style>
</head>
<body class="p-6">
  <main class="max-w-6xl mx-auto space-y-6">
    <header class="flex items-center justify-between pb-3 border-b border-gray-200">
      <h1 class="text-2xl font-black">‚öôÔ∏è Calculateur <span class="text-blue-600">SPRINT</span> & <span class="text-green-600">GMT</span></h1>
      <div class="flex items-center gap-2">
        <button id="btnTheme" class="btn" title="Basculer th√®me" onclick="toggleTheme()">üåô</button>
        <span class="bg-gray-200 px-2 py-1 rounded text-xs">v5.2 ‚Äî NST2 sans √ó1.5 (IHM) + tests MAJ</span>
      </div>
    </header>

    <!-- Onglets principaux avec badges de pr√©diction -->
    <div class="flex rounded-lg overflow-hidden border border-gray-200">
      <button id="tabSprint" class="flex-1 btn tab-active flex items-center justify-between gap-2" onclick="switchTab('sprint')">
        <span>SPRINT</span>
        <span id="tabSprintPred" class="text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-700">A ‚Äî / B ‚Äî</span>
      </button>
      <button id="tabGmt" class="flex-1 btn flex items-center justify-between gap-2" onclick="switchTab('gmt')">
        <span>GMT</span>
        <span id="tabGmtPred" class="text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-700">A ‚Äî / B ‚Äî</span>
      </button>
    </div>

    <!-- Sous-onglets Sprint (NST1/NST2) -->
    <div id="sprintTabs" class="flex mt-2 rounded-lg overflow-hidden border border-gray-200">
      <button id="tabNST1" class="flex-1 btn tab-active" onclick="switchSprint('nst1')">NST1</button>
      <button id="tabNST2" class="flex-1 btn" onclick="switchSprint('nst2')">NST2</button>
    </div>

    <!-- SPRINT -->
    <section id="viewSprint" class="card p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="title">SPRINT (<span id="sprintMode">NST1</span>)</h2>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-semibold mb-2">Valeurs attendues</h3>
          <label id="attALabel" class="label">C√¥t√© A (Frein)</label>
          <input id="attA" type="number" step="0.1" class="input mb-2" value="145" />
          <label id="attBLabel" class="label">C√¥t√© B (Coupe)</label>
          <input id="attB" type="number" step="0.1" class="input" value="142" />
        </div>
        <div>
          <h3 class="font-semibold mb-2">Valeurs mesur√©es</h3>
          <label id="mesALabel" class="label">C√¥t√© A (Frein)</label>
          <input id="mesA" type="number" step="0.1" class="input mb-2" value="141" />
          <label id="mesBLabel" class="label">C√¥t√© B (Coupe)</label>
          <input id="mesB" type="number" step="0.1" class="input" value="147" />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div>
          <label class="label">Facteur centrage (IHM)</label>
          <input id="factCentrage" type="number" step="0.01" class="input" value="0.2" />
          <p class="text-xs muted mt-1">Centrage = (Mesur√© Coupe ‚àí Attendu Coupe) √ó facteur ‚Üí <b>arrondi pas 0,10</b>.</p>
        </div>
        <div>
          <label class="label">Facteur longueur fil</label>
          <input id="factLong" type="number" step="0.01" class="input" value="1.5" />
          <p class="text-xs muted mt-1">Commande IHM = (Att Frein ‚àí Frein apr√®s centrage) √ó facteur ‚Üí <b>arrondi pas 0,25</b>.</p>
        </div>
        <div>
          <label class="label">Tol√©rance (mm)</label>
          <input id="tolSprint" type="number" step="0.1" class="input" value="0.5" />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
        <div class="bg-gray-50 p-4 rounded-lg border">
          <p class="subtitle">Centrage IHM</p>
          <div id="sprintCentrage" class="highlight">+0.0</div>
          <div id="sprintCentrageHint" class="text-xs muted mt-1">‚Äî</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg border">
          <p class="subtitle">Longueur fil (IHM)</p>
          <div id="sprintLongueur" class="highlight">+0.00 mm</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg border">
          <p class="subtitle">Pr√©dictions</p>
          <div id="sPredA" class="highlight">A ‚Äî</div>
          <div id="sPredB" class="highlight">B ‚Äî</div>
          <div id="sTol" class="pill ok mt-1">‚Äî</div>
        </div>
      </div>

      <details class="mt-4">
        <summary class="font-semibold">D√©tail du calcul</summary>
        <pre id="logSprint" class="text-xs bg-gray-50 p-3 rounded border"></pre>
      </details>
    </section>

    <!-- GMT -->
    <section id="viewGmt" class="card p-6 hidden">
      <h2 class="title mb-4">GMT</h2>
      <p class="muted mb-4">√âtapes : 1) corriger la <b>longueur totale</b> avec les dents (50/50 fixe), 2) √©quilibrer A/B avec le <b>centrage</b>.</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-semibold mb-2">Valeurs attendues</h3>
          <label class="label">C√¥t√© A</label>
          <input id="gAttA" type="number" step="0.5" class="input mb-2" value="110" />
          <label class="label">C√¥t√© B</label>
          <input id="gAttB" type="number" step="0.5" class="input" value="110" />
        </div>
        <div>
          <h3 class="font-semibold mb-2">Valeurs mesur√©es</h3>
          <label class="label">C√¥t√© A</label>
          <input id="gMesA" type="number" step="0.5" class="input mb-2" value="108.5" />
          <label class="label">C√¥t√© B</label>
          <input id="gMesB" type="number" step="0.5" class="input" value="108.5" />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div>
          <label class="label">Dent (mm total)</label>
          <input id="dentTotal" type="number" step="0.01" class="input" value="2.78" />
        </div>
        <div>
          <label class="label">R√©partition dents</label>
          <div class="input bg-gray-50">50% / 50% (fixe)</div>
        </div>
        <div>
          <label class="label">Tol√©rance centrage (mm)</label>
          <input id="tolGmt" type="number" step="0.5" class="input" value="40" />
          <p class="text-xs muted">Borne ¬±mm appliqu√©e au centrage.</p>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
        <div class="bg-gray-50 p-4 rounded-lg border">
          <p class="subtitle">Mise en angle</p>
          <div id="gmtDent" class="highlight">0 dent</div>
          <div id="gmtDentAction" class="text-xs muted">‚Äî</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg border">
          <p class="subtitle">Centrage (mm)</p>
          <div id="gmtCentMm" class="highlight">+0.00 mm</div>
          <div id="gmtCentDirection" class="text-xs muted">‚Äî</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg border">
          <p class="subtitle">Pr√©dictions</p>
          <div id="gPredA" class="highlight">A ‚Äî</div>
          <div id="gPredB" class="highlight">B ‚Äî</div>
        </div>
      </div>
      <details class="mt-4">
        <summary class="font-semibold">D√©tail du calcul</summary>
        <pre id="logGmt" class="text-xs bg-gray-50 p-3 rounded border"></pre>
      </details>
    </section>

    <!-- TESTS -->
    <section class="card p-6">
      <details>
        <summary class="font-semibold cursor-pointer">üß™ Tests int√©gr√©s (cliquer pour ouvrir)</summary>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-primary" id="btnRunTests">Ex√©cuter</button>
          <button class="btn" id="btnResetEx">R√©initialiser valeurs exemple</button>
        </div>
        <pre id="testOutput" class="text-xs bg-gray-50 p-3 rounded border mt-3 whitespace-pre-wrap"></pre>
      </details>
    </section>
  </main>

  <script>
  // ===== State =====
  let sprintMode = 'nst1'; // 'nst1' ou 'nst2'
  let theme = 'light';

  // ===== Utils =====
  const $ = (id) => document.getElementById(id);
  const fr = (n) => Number(n ?? 0);
  const round2 = (x) => Math.round(x * 100) / 100;
  const fmt = (x) => (x >= 0 ? "+" : "") + round2(x).toFixed(2);
  const fmt1 = (x) => (x >= 0 ? "+" : "") + (Math.round(x*10)/10).toFixed(1);
  function snapTo(v, step){ const s = Number(step||0.1); if(!isFinite(v)) return 0; return Math.round(v/s)*s; }
  function safeToggle(el, cls, on){ if(!el) return; el.classList.toggle(cls, !!on); }
  function safeText(id, txt){ const el=$(id); if(el) el.textContent=txt; }

  // ===== Tabs & Theme & PWA =====
  function switchTab(name){
    safeToggle($("viewSprint"), 'hidden', name !== 'sprint');
    safeToggle($("viewGmt"), 'hidden', name !== 'gmt');
    safeToggle($("tabSprint"), 'tab-active', name === 'sprint');
    safeToggle($("tabGmt"), 'tab-active', name === 'gmt');
  }

  function applyTheme(){
    const html = document.documentElement;
    if(theme==='dark') html.classList.add('dark'); else html.classList.remove('dark');
    const b = $("btnTheme"); if(b) b.textContent = theme==='dark' ? '‚òÄÔ∏è' : 'üåô';
  }
  function toggleTheme(){ theme = (theme==='dark') ? 'light' : 'dark'; localStorage.setItem('calc.theme', theme); applyTheme(); }
  function initTheme(){ theme = localStorage.getItem('calc.theme') || 'light'; applyTheme(); }

  // PWA minimal offline (service worker en m√©moire)
  async function registerPWA(){
    if(!('serviceWorker' in navigator)) return;
    const swCode = `const CACHE='calc-v1';self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./','https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css'])))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const copy=res.clone();caches.open(CACHE).then(c=>c.put(e.request,copy));return res;})).catch(()=>caches.match('./')))});`;
    const blob = new Blob([swCode], {type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    try{ await navigator.serviceWorker.register(url, {scope:'./'}); }catch(_){ /* ignore */ }
  }

  // ===== NST sous-onglets =====
  function switchSprint(mode){
    sprintMode = mode;
    safeToggle($("tabNST1"), 'tab-active', mode==='nst1');
    safeToggle($("tabNST2"), 'tab-active', mode==='nst2');
    safeText("sprintMode", mode.toUpperCase());
    updateSprintLabels();
    runSprint();
  }

  function updateSprintLabels(){
    const la=$("attALabel"), lb=$("attBLabel"), lma=$("mesALabel"), lmb=$("mesBLabel");
    if(sprintMode==='nst1'){
      if(la) la.textContent='C√¥t√© A (Frein)';
      if(lb) lb.textContent='C√¥t√© B (Coupe)';
      if(lma) lma.textContent='C√¥t√© A (Frein)';
      if(lmb) lmb.textContent='C√¥t√© B (Coupe)';
    } else {
      if(la) la.textContent='C√¥t√© A (Coupe)';
      if(lb) lb.textContent='C√¥t√© B (Frein)';
      if(lma) lma.textContent='C√¥t√© A (Coupe)';
      if(lmb) lmb.textContent='C√¥t√© B (Frein)';
    }
  }

  // ===== SPRINT (centrage auto-optimal 0,1 ; longueur fil pas 0,25 ; NST mapping) =====
  function runSprint(){
    const attA=fr($("attA").value), attB=fr($("attB").value);
    const mesA=fr($("mesA").value), mesB=fr($("mesB").value);
    const kC=fr($("factCentrage").value||0.2);

    // Facteur longueur fil (commande IHM) + conversion sp√©cifique NST2
    const kLInput = fr($("factLong").value||1.5);
    const kL = kLInput;

    const tol=fr($("tolSprint").value||0.5);

    // Mapping selon NST : quelle est la Coupe/Frein active ?
    let attCoupe, attFrein, mesCoupe, mesFrein;
    if(sprintMode==='nst1'){ attFrein=attA; attCoupe=attB; mesFrein=mesA; mesCoupe=mesB; }
    else                   { attCoupe=attA; attFrein=attB; mesCoupe=mesA; mesFrein=mesB; }

    // √âcart Coupe ‚Üí centrage (pas 0,1)
    const decal = mesCoupe - attCoupe; // + => Coupe trop grande
    const stepC = 0.1;
    const centrageRaw = decal * kC;
    const base = Math.floor(centrageRaw/stepC)*stepC;
    const candidates = Array.from(new Set([
      base,
      Math.round(centrageRaw/stepC)*stepC,
      base + stepC
    ])).sort((a,b)=>a-b);

    function simulate(centIhm){
      const appliedDecal = kC ? centIhm / kC : 0; // mm appliqu√©s physiquement
      const coupeAfter = round2(mesCoupe - appliedDecal);
      const freinAfter = round2(mesFrein + appliedDecal);

      // Longueur fil (commande IHM) au pas 0,25
      const corrLongRaw = (attFrein - freinAfter) * kL; // commande IHM
      const corrLong = snapTo(corrLongRaw, 0.25);
      const predCoupe = coupeAfter;
      const predFrein = round2(freinAfter + (kL ? corrLong / kL : 0)); // effet r√©el

      // Remap vers A/B en fonction du mode
      const predA = (sprintMode==='nst1') ? predFrein : predCoupe;
      const predB = (sprintMode==='nst1') ? predCoupe : predFrein;
      const errA = Math.abs(predA - attA);
      const errB = Math.abs(predB - attB);
      const maxErr = Math.max(errA, errB);
      const sumErr = errA + errB;
      return { centIhm, appliedDecal, corrLong, predCoupe, predFrein, predA, predB, errA, errB, maxErr, sumErr };
    }

    const sims = candidates.map(simulate);
    sims.sort((u,v)=> u.maxErr - v.maxErr || u.sumErr - v.sumErr || Math.abs(u.centIhm-centrageRaw) - Math.abs(v.centIhm-centrageRaw));
    const best = sims[0];

    // Sorties SPRINT
    safeText("sprintCentrage", fmt1(best.centIhm));
    safeText("sprintLongueur", fmt(best.corrLong) + " mm");
    safeText("sPredA", `A ${best.predA.toFixed(2)} mm (att ${attA.toFixed(2)})`);
    safeText("sPredB", `B ${best.predB.toFixed(2)} mm (att ${attB.toFixed(2)})`);
    const ok = (best.errA <= tol) && (best.errB <= tol);
    const tolEl = $("sTol"); if(tolEl){ tolEl.textContent = ok? 'OK':'Hors tol√©rance'; tolEl.className='pill ' + (ok? 'ok':'bad'); }

    // Badge de l'onglet SPRINT
    safeText('tabSprintPred', `A ${best.predA.toFixed(2)} / B ${best.predB.toFixed(2)}`);

    // Indication du prochain palier 0,1
    const up = Math.ceil(centrageRaw/stepC)*stepC;
    const down = Math.floor(centrageRaw/stepC)*stepC;
    const needUp = kC ? round2((up-centrageRaw)/kC) : 0;
    const needDown = kC ? round2((centrageRaw-down)/kC) : 0;
    const hint = (needUp>0 || needDown>0)
      ? `Prochain palier 0,1 : +${needUp} mm Coupe pour ${(up>=0?'+':'')+up.toFixed(1)} ou ‚àí${needDown} mm pour ${(down>=0?'+':'')+down.toFixed(1)}`
      : '‚Äî';
    safeText("sprintCentrageHint", hint);

    // Log clair
    const log=[];
    log.push(`Mode SPRINT = ${sprintMode.toUpperCase()} (kL cmd = ${kL.toFixed(2)})`);
    log.push(`√âcart Coupe = ${round2(mesCoupe)} ‚àí ${round2(attCoupe)} = ${round2(decal)} mm`);
    log.push(`Centrage brut = ${round2(centrageRaw)} ‚Üí candidats (0,1) = ${candidates.map(x => (x >= 0 ? '+' : '') + x.toFixed(1)).join(' / ')}`);
    log.push(`Choix auto-optimal = ${fmt1(best.centIhm)} (d√©placement r√©el = ${best.appliedDecal.toFixed(2)} mm)`);
    log.push(`Apr√®s centrage: Coupe‚âà${best.predCoupe.toFixed(2)}, Frein avant fil‚âà${(round2(mesFrein + (best.centIhm/(kC||1)))).toFixed(2)}`);
    log.push(`Longueur fil IHM (pas 0,25) = ${fmt(best.corrLong)} mm ‚Üí Frein pr√©vu ‚âà ${best.predFrein.toFixed(2)}`);
    log.push(`Pr√©dictions finales A/B = ${best.predA.toFixed(2)} / ${best.predB.toFixed(2)} (tol ¬±${tol})`);
    safeText("logSprint", log.join('\n'));
  }

  // ===== GMT (50/50) =====
  function runGmt(){
    const attA=fr($("gAttA").value), attB=fr($("gAttB").value);
    const mesA=fr($("gMesA").value), mesB=fr($("gMesB").value);
    const dentTot=fr($("dentTotal").value||2.78);
    const limCent=fr($("tolGmt").value||40); // borne centrage

    // 1) Longueur totale
    const Lm=mesA+mesB, La=attA+attB, dL=La-Lm; // >0 = trop court ‚Üí ajouter
    const rSel=0.5; // pas 0,5 dent
    let n=Math.round((dL/dentTot)/rSel)*rSel;

    // 50/50
    const addA=n*dentTot*0.5, addB=n*dentTot*0.5;
    const A1=mesA+addA, B1=mesB+addB;

    // 2) Centrage A/B
    const rA=attA-A1, rB=attB-B1;
    let s=(rA-rB)/2; // >0 : centrer vers A
    s=Math.max(Math.min(s, limCent), -limCent);

    const A2=round2(A1+s), B2=round2(B1-s);

    // UI + badge onglet
    const actionDent = n>0 ? `‚ñ∂Ô∏é Ajouter ${n} dent(s)` : n<0 ? `‚óÄÔ∏é Retirer ${Math.abs(n)} dent(s)` : `‚Äî Aucune dent`;
    const dirCent = s>0 ? `‚ñ∂Ô∏é Centrer vers A` : s<0 ? `‚óÄÔ∏é Centrer vers B` : `‚Äî Aucun centrage`;
    safeText('gmtDent', `${n} dent${Math.abs(n)===1?'':'s'}`);
    safeText('gmtDentAction', `${actionDent} (ŒîL=${round2(dL)} mm)`);
    safeText('gmtCentMm', `${fmt(s)} mm`);
    safeText('gmtCentDirection', dirCent);
    safeText('gPredA', `A ${A2} mm (att ${attA})`);
    safeText('gPredB', `B ${B2} mm (att ${attB})`);
    safeText('tabGmtPred', `A ${A2.toFixed(2)} / B ${B2.toFixed(2)}`);

    // Log GMT
    const log=[];
    log.push(`1Ô∏è‚É£ Longueurs: mes=${round2(Lm)}, att=${round2(La)}, ŒîL=${round2(dL)} mm ‚Üí n=${n}`);
    log.push(`2Ô∏è‚É£ Dents 50/50 : +${addA.toFixed(2)} mm sur A, +${addB.toFixed(2)} mm sur B ‚Üí A1=${A1.toFixed(2)}, B1=${B1.toFixed(2)}`);
    log.push(`3Ô∏è‚É£ Restes: rA=${(attA-A1).toFixed(2)}, rB=${(attB-B1).toFixed(2)} ‚áí s=(rA‚àírB)/2=${round2((rA-rB)/2)} mm (born√© ¬±${limCent})`);
    log.push(`4Ô∏è‚É£ Final (pr√©diction): A=${A2.toFixed(2)} mm, B=${B2.toFixed(2)} mm`);
    safeText('logGmt', log.join('\n'));
  }

  // ===== Tests =====
  function getSprintSnapshot(){
    return {
      centrage: $("sprintCentrage").textContent,
      longueur: $("sprintLongueur").textContent,
      tab: $("tabSprintPred").textContent,
      predA: $("sPredA").textContent,
      predB: $("sPredB").textContent,
    };
  }
  function approxEqual(a,b,eps){ return Math.abs(a-b) <= (eps ?? 0.26); }

  function runTests(){
    const out=[];
    try{
      // ===== SPRINT: NST1 de r√©f√©rence =====
      $("attA").value=145; $("attB").value=142; $("mesA").value=141; $("mesB").value=147; $("factCentrage").value=0.2; $("factLong").value=1.5; $("tolSprint").value=0.5;
      switchSprint('nst1'); runSprint();
      let s1 = getSprintSnapshot();
      out.push(`T1 SPRINT NST1 ‚Üí ${s1.tab}`);

      // ===== SPRINT: NST1 ‚Üî NST2 mapping check =====
      const tabNST1 = $("tabSprintPred").textContent;
      switchSprint('nst2'); runSprint();
      const tabNST2 = $("tabSprintPred").textContent;
      out.push(`T2 Mapping NST1(${tabNST1}) ‚Üî NST2(${tabNST2})`);

      // ===== SPRINT: V√©rif invariance de la commande IHM entre NST1 et NST2 =====
      switchSprint('nst1'); runSprint();
      const L1 = parseFloat($("sprintLongueur").textContent);
      switchSprint('nst2'); runSprint();
      const L2 = parseFloat($("sprintLongueur").textContent);
      const ratio = (Math.abs(L1) > 0.01) ? Math.abs(L2/L1) : 1;
      const okRatio = approxEqual(ratio, 1.0, 0.3) || (Math.abs(L1)<0.26 && Math.abs(L2)<0.26);
      out.push(`T3 Invariance kL (NST1‚ÜíNST2) ‚Üí L1=${isFinite(L1)?L1.toFixed(2):'NaN'} / L2=${isFinite(L2)?L2.toFixed(2):'NaN'} (ratio‚âà${isFinite(ratio)?ratio.toFixed(2):'‚Äî'}) ‚áí ${okRatio?'OK':'CHECK'}`);

      // ===== SPRINT: Seuils de palier ŒîCoupe ¬±0,5 (kC=0,2) ‚Üí saut de 0,1 =====
      $("attB").value=142; $("mesB").value=147; $("factCentrage").value=0.2; switchSprint('nst1'); runSprint();
      const cBase = $("sprintCentrage").textContent;
      $("mesB").value=147.49; runSprint(); const cUp49 = $("sprintCentrage").textContent;
      $("mesB").value=147.51; runSprint(); const cUp51 = $("sprintCentrage").textContent;
      out.push(`T4 Palier +: base=${cBase}, +0.49‚Üí${cUp49}, +0.51‚Üí${cUp51}`);
      $("mesB").value=146.51; runSprint(); const cDn49 = $("sprintCentrage").textContent;
      $("mesB").value=146.49; runSprint(); const cDn51 = $("sprintCentrage").textContent;
      out.push(`T5 Palier ‚àí:  ‚àí0.49‚Üí${cDn49}, ‚àí0.51‚Üí${cDn51}`);

      // ===== GMT de base & cas long =====
      $("gAttA").value=110; $("gAttB").value=110; $("gMesA").value=108.5; $("gMesB").value=108.5; $("dentTotal").value=2.78; $("tolGmt").value=40; runGmt();
      out.push(`T6 GMT ‚Üí ${$("gmtDent").textContent}, ${$("gmtCentMm").textContent}, tab=${$("tabGmtPred").textContent}`);
      $("gMesA").value=112; $("gMesB").value=112; runGmt();
      out.push(`T7 GMT long ‚Üí ${$("gmtDent").textContent}, ${$("gmtCentMm").textContent}`);

    }catch(e){ out.push('‚ùå Exception tests: '+(e && e.message ? e.message : e)); }
    $("testOutput").textContent = out.join('\n');
  }

  function resetExample(){
    // SPRINT
    $("attA").value=145; $("attB").value=142; $("mesA").value=141; $("mesB").value=147; $("factCentrage").value=0.2; $("factLong").value=1.5; $("tolSprint").value=0.5;
    // GMT
    $("gAttA").value=110; $("gAttB").value=110; $("gMesA").value=108.5; $("gMesB").value=108.5; $("dentTotal").value=2.78; $("tolGmt").value=40;
    // Mode par d√©faut
    switchSprint('nst1');
  }

  // ===== Init & bindings =====
  document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    registerPWA();
    switchTab('sprint');
    updateSprintLabels();

    // Recalcul dynamique SPRINT
    ["attA","attB","mesA","mesB","factCentrage","factLong","tolSprint"].forEach(id=>{
      const el=$(id); if(!el) return; el.addEventListener('input', runSprint);
    });
    // Recalcul dynamique GMT
    ["gAttA","gAttB","gMesA","gMesB","dentTotal","tolGmt"].forEach(id=>{
      const el=$(id); if(!el) return; el.addEventListener('input', runGmt);
    });

    // Boutons tests
    const bt1 = document.getElementById('btnRunTests'); if(bt1) bt1.addEventListener('click', runTests);
    const bt2 = document.getElementById('btnResetEx'); if(bt2) bt2.addEventListener('click', ()=>{ resetExample(); runSprint(); runGmt(); });

    // Premier calcul
    resetExample();
    runSprint();
    runGmt();
  });
  </script>
</body>
</html>
